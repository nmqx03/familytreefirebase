<!DOCTYPE html>
<html lang="vi">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>S∆° ƒê·ªì Ph·∫£ H·ªá H·ªç Nguy·ªÖn</title>
    <link rel="stylesheet" href="style.css">
    <link rel="icon" type="image/png" href="images/android-icon-36x36.png">
    
    <!-- Firebase SDK (Compat version) -->
    <script src="https://www.gstatic.com/firebasejs/9.22.0/firebase-app-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/9.22.0/firebase-auth-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/9.22.0/firebase-database-compat.js"></script>

    
</head>
<body>
    <!-- Sync Indicator (·∫©n status dot) -->
    <div class="sync-indicator" id="syncIndicator" style="display: none; position: fixed; bottom: 20px; right: 20px; padding: 10px 20px; background: #4CAF50; color: white; border-radius: 25px; box-shadow: 0 4px 12px rgba(0,0,0,0.2); font-size: 14px; z-index: 999;">
        ‚úì ƒê√£ ƒë·ªìng b·ªô
    </div>
    <div class="container">
        <header class="header">
            <h1>S∆° ƒê·ªì Ph·∫£ H·ªá H·ªç Nguy·ªÖn</h1>
            <p class="subtitle"></p>
        </header>
        
        <!-- Canvas xem ph·∫£ h·ªá -->
        <div class="tree-container">
            <div class="zoom-controls">
                <button id="undoBtn" title="Ho√†n t√°c (Ctrl+Z)" style="display: none;">‚Ü∂</button>
                <button id="redoBtn" title="L√†m l·∫°i (Ctrl+Y)" style="display: none;">‚Ü∑</button>
                <button id="zoomIn">+</button>
                <button id="zoomReset">Reset</button>
                <button id="zoomOut">‚àí</button>
            </div>
            <div id="treeCanvas" class="tree-canvas"></div>
        </div>

        <!-- T√¨m ki·∫øm -->
        <div class="form-section">
            <h2>üîç T√¨m Ki·∫øm Ng∆∞·ªùi</h2>
            <div class="form-group">
                <label for="searchName">T√™n ng∆∞·ªùi c·∫ßn t√¨m:</label>
                <input type="text" id="searchName" placeholder="Nh·∫≠p t√™n ƒë·ªÉ t√¨m ki·∫øm..." autocomplete="off">
            </div>
            <div id="searchResults"></div>
        </div>

        <!-- Th·ªëng k√™ -->
        <!-- <div class="form-section">
            <h2>üìä Th·ªëng K√™ Ph·∫£ H·ªá</h2>
            <div class="stats-grid">
                <div class="stat-item">
                    <div class="stat-label">T·ªïng th√†nh vi√™n</div>
                    <div class="stat-value" id="totalMembers">0</div>
                </div>
                <div class="stat-item">
                    <div class="stat-label">Nam c√≤n s·ªëng</div>
                    <div class="stat-value" id="maleCount">0</div>
                </div>
                <div class="stat-item">
                    <div class="stat-label">N·ªØ c√≤n s·ªëng</div>
                    <div class="stat-value" id="femaleCount">0</div>
                </div>

                <div class="stat-item">
                    <div class="stat-label">ƒê√£ m·∫•t</div>
                    <div class="stat-value" id="deceasedCount">0</div>
                </div>
                
                <div class="stat-item">
                    <div class="stat-label">S·ªë th·∫ø h·ªá</div>
                    <div class="stat-value" id="generationCount">0</div>
                </div>
                <div class="stat-item">
                    <div class="stat-label">0-15 tu·ªïi</div>
                    <div class="stat-value" id="ageGroup1">0</div>
                </div>
                <div class="stat-item">
                    <div class="stat-label">16-64 tu·ªïi</div>
                    <div class="stat-value" id="ageGroup2">0</div>
                </div>
                <div class="stat-item">
                    <div class="stat-label">‚â• 65 tu·ªïi</div>
                    <div class="stat-value" id="ageGroup3">0</div>
                </div>
            </div>
        </div>
    </div> -->

    <!-- Ph·∫ßn qu·∫£n tr·ªã - hi·ªÉn th·ªã sau khi ƒëƒÉng nh·∫≠p -->
    <div class="admin-section">
        <div class="container">
            <!-- Hi·ªÉn th·ªã khi ch∆∞a ƒëƒÉng nh·∫≠p -->
            <div id="loginPrompt" class="admin-login-prompt">
                <h2>üîê Ch·∫ø ƒê·ªô Qu·∫£n Tr·ªã</h2>
                <button class="btn-login" onclick="showLoginForm()">ƒêƒÉng Nh·∫≠p Qu·∫£n Tr·ªã</button>
            </div>

            <!-- Form ƒëƒÉng nh·∫≠p inline -->
            <div id="loginForm" style="display: none;" class="admin-login-prompt">
                <h2>üîê ƒêƒÉng Nh·∫≠p </h2>
                <p style="font-size: 13px; color: #999;">S·ª≠ d·ª•ng email v√† m·∫≠t kh·∫©u </p>
                <div id="loginError" style="display: none; color: #f44336; margin-bottom: 15px; font-weight: 600;"></div>
                <div id="loginSuccess" style="display: none; color: #4CAF50; margin-bottom: 15px; font-weight: 600;"></div>
                <form onsubmit="handleFirebaseLogin(event)" style="max-width: 400px; margin: 0 auto;">
                    <div class="form-group" style="text-align: left;">
                        <label for="loginEmail">Email:</label>
                        <input type="email" id="loginEmail" required autocomplete="email" placeholder="admin@example.com" style="width: 100%;">
                    </div>
                    <div class="form-group" style="text-align: left;">
                        <label for="loginPassword">M·∫≠t kh·∫©u:</label>
                        <input type="password" id="loginPassword" required autocomplete="current-password" placeholder="Nh·∫≠p m·∫≠t kh·∫©u..." style="width: 100%;">
                    </div>
                    <button type="submit" class="btn-primary" id="loginBtn" style="width: 100%; margin-top: 10px;">
                        <span id="loginBtnText">ƒêƒÉng Nh·∫≠p</span>
                        <span id="loginBtnLoading" style="display: none;">‚è≥ ƒêang ƒëƒÉng nh·∫≠p...</span>
                    </button>
                    <button type="button" class="btn-secondary" style="width: 100%; margin-top: 10px;" onclick="cancelLogin()">H·ªßy</button>
                </form>
            </div>

            <!-- Ph·∫ßn qu·∫£n tr·ªã - hi·ªÉn th·ªã sau khi ƒëƒÉng nh·∫≠p -->
            <div id="adminControls" class="admin-controls">
                <div class="admin-header">
                    <div>
                        <h2>‚öôÔ∏è Qu·∫£n Tr·ªã Ph·∫£ H·ªá</h2>
                        <div id="userEmail" style="font-size: 14px; opacity: 0.9; margin-top: 5px;"></div>
                    </div>
                    <button class="btn-logout" onclick="handleLogout()">üö™ ƒêƒÉng Xu·∫•t</button>
                </div>
                
                <div class="controls-panel" style="margin-top: 0; padding-top: 20px;">
                    <div class="form-section">
                        <h2>Th√™m Th√†nh Vi√™n</h2>
                        <form id="addMemberForm">
                            <div class="form-group">
                                <label for="memberName">H·ªç v√† t√™n:</label>
                                <input type="text" id="memberName" required autocomplete="off" maxlength="30">
                            </div>
                            
                            <div class="form-group">
                                <label for="memberGender">Gi·ªõi t√≠nh:</label>
                                <select id="memberGender" required>
                                    <option value="male">Nam</option>
                                    <option value="female">N·ªØ</option>
                                </select>
                            </div>

                            <div class="form-group">
                                <label for="birthYear">NƒÉm sinh:</label>
                                <input type="text" id="birthYear" placeholder="" autocomplete="off" maxlength="4">
                            </div>

                            <div class="form-group">
                                <label for="deathYear">NƒÉm m·∫•t:</label>
                                <div style="display: flex; align-items: center; gap: 10px; margin-bottom: 8px;">
                                    <input type="checkbox" id="isDeceased" style="width: auto; margin: 0;">
                                    <label for="isDeceased" style="margin: 0; cursor: pointer;">ƒê√£ m·∫•t</label>
                                </div>
                                <input type="text" id="deathYear" placeholder="Nh·∫≠p nƒÉm m·∫•t..." autocomplete="off" maxlength="4">
                            </div>

                            <div class="form-group">
                                <label for="hometown">Qu√™ qu√°n:</label>
                                <input type="text" id="hometown" placeholder="Nh·∫≠p qu√™ qu√°n..." autocomplete="off" maxlength="50">
                            </div>

                            <div class="form-group">
                                <label for="parentId">Ch·ªçn cha/m·∫π:</label>
                                <div class="searchable-select" id="parentSelectContainer">
                                    <input type="text" class="select-search" id="parentSearch" placeholder="T√¨m ho·∫∑c ch·ªçn..." autocomplete="off">
                                    <div class="select-options" id="parentOptions"></div>
                                </div>
                                <input type="hidden" id="parentId">
                                <div id="childrenInfo" style="margin-top: 8px; font-size: 0.85rem; color: var(--text-secondary); font-style: italic;"></div>
                            </div>

                            <div class="form-group" id="childOrderGroup" style="display: none;">
                                <label for="childOrder">L√† con th·ª©:</label>
                                <select id="childOrder">
                                    <option value="">-- Ch·ªçn th·ª© t·ª± --</option>
                                </select>
                            </div>

                            <div class="form-group" id="spouseParentGroup" style="display: none;" autocomplete="off">
                                <label for="spouseParentId">L√† con c·ªßa (Cha/M·∫π):</label>
                                <div class="searchable-select" id="spouseParentSelectContainer">
                                    <input type="text" class="select-search" id="spouseParentSearch" placeholder="Ch·ªçn v·ª£/ch·ªìng c·ªßa ng∆∞·ªùi ƒë√£ ch·ªçn ·ªü tr√™n..."autocomplete="off">
                                    <div class="select-options" id="spouseParentOptions"></div>
                                </div>
                                <input type="hidden" id="spouseParentId">
                            </div>

                            <div class="form-group">
                                <label for="notes">Ghi ch√∫:</label>
                                <textarea id="notes" rows="3" placeholder="T·ªëi ƒëa 250 k√Ω t·ª±." autocomplete="off" maxlength="250"></textarea>
                            </div>

                            <button type="submit" class="btn-primary">Th√™m th√†nh vi√™n</button>
                        </form>
                    </div>

                    <div class="form-section">
                        <h2>Th√™m V·ª£/Ch·ªìng</h2>
                        <form id="addSpouseForm">
                            <div class="form-group">
                                <label for="spouseMemberId">Ch·ªçn th√†nh vi√™n:</label>
                                <div class="searchable-select" id="spouseMemberSelectContainer">
                                    <input type="text" class="select-search" id="spouseMemberSearch" placeholder="T√¨m ho·∫∑c ch·ªçn..." autocomplete="off">
                                    <div class="select-options" id="spouseMemberOptions"></div>
                                </div>
                                <input type="hidden" id="spouseMemberId">
                            </div>

                            <div class="form-group">
                                <label for="spouseName">T√™n v·ª£/ch·ªìng:</label>
                                <input type="text" id="spouseName" required autocomplete="off" maxlength="30">
                            </div>

                            <div class="form-group">
                                <label for="spouseBirthYear">NƒÉm sinh:</label>
                                <input type="text" id="spouseBirthYear" autocomplete="off" maxlength="4">
                            </div>

                            <div class="form-group">
                                <label for="spouseDeathYear">NƒÉm m·∫•t:</label>
                                <div style="display: flex; align-items: center; gap: 10px; margin-bottom: 8px;">
                                    <input type="checkbox" id="spouseIsDeceased" style="width: auto; margin: 0;">
                                    <label for="spouseIsDeceased" style="margin: 0; cursor: pointer;">ƒê√£ m·∫•t</label>
                                </div>
                                <input type="text" id="spouseDeathYear" autocomplete="off" maxlength="4" placeholder="Nh·∫≠p nƒÉm m·∫•t...">
                            </div>

                            <div class="form-group">
                                <label for="spouseHometown">Qu√™ qu√°n:</label>
                                <input type="text" id="spouseHometown" placeholder="Nh·∫≠p qu√™ qu√°n..." autocomplete="off" maxlength="50">
                            </div>

                            <div class="form-group">
                                <label for="spouseOrder">L√† v·ª£/ch·ªìng th·ª©:</label>
                                <select id="spouseOrder">
                                    <option value="">-- Ch·ªçn th·ª© t·ª± --</option>
                                </select>
                            </div>

                            <div class="form-group">
                                <label for="spouseNotes">Ghi ch√∫:</label>
                                <textarea id="spouseNotes" rows="3" placeholder="T·ªëi ƒëa 250 k√Ω t·ª±." autocomplete="off" maxlength="250"></textarea>
                            </div>

                            <button type="submit" class="btn-secondary">Th√™m v·ª£/ch·ªìng</button>
                        </form>
                    </div>

                    <div class="action-buttons">
                        <button id="resetBtn" class="btn-danger">X√≥a to√†n b·ªô d·ªØ li·ªáu</button>
                        <button id="exportBtn" class="btn-info">Xu·∫•t d·ªØ li·ªáu</button>
                        <button id="importBtn" class="btn-info">Nh·∫≠p d·ªØ li·ªáu</button>
                        <input type="file" id="importFile" accept=".json" style="display: none;">
                    </div>
                </div>
            </div>
        </div>
    </div>

    <!-- Edit Modal -->
    <div id="editModal" class="modal">
        <div class="modal-content">
            <span class="close-modal">&times;</span>
            <h2>S·ª≠a Th√¥ng Tin</h2>
            <form id="editMemberForm">
                <input type="hidden" id="editMemberId">
                <div class="form-group">
                    <label for="editMemberName">H·ªç v√† t√™n:</label>
                    <input type="text" id="editMemberName" required maxlength="30" autocomplete="off">
                </div>
                
                <div class="form-group">
                    <label for="editMemberGender">Gi·ªõi t√≠nh:</label>
                    <select id="editMemberGender" required>
                        <option value="male">Nam</option>
                        <option value="female">N·ªØ</option>
                    </select>
                </div>

                <div class="form-group">
                    <label for="editBirthYear">NƒÉm sinh:</label>
                    <input type="text" id="editBirthYear" maxlength="4" autocomplete="off">
                </div>

                <div class="form-group">
                    <label for="editDeathYear">NƒÉm m·∫•t:</label>
                    <div style="display: flex; align-items: center; gap: 10px; margin-bottom: 8px;">
                        <input type="checkbox" id="editIsDeceased" style="width: auto; margin: 0;">
                        <label for="editIsDeceased" style="margin: 0; cursor: pointer;">ƒê√£ m·∫•t</label>
                    </div>
                    <input type="text" id="editDeathYear" maxlength="4" placeholder="Nh·∫≠p nƒÉm m·∫•t..."autocomplete="off">
                </div>

                <div class="form-group">
                    <label for="editHometown">Qu√™ qu√°n:</label>
                    <input type="text" id="editHometown" placeholder="Nh·∫≠p qu√™ qu√°n..." autocomplete="off" maxlength="50">
                </div>

                <div class="form-group">
                    <label for="editParentId">Ch·ªçn Cha/M·∫π:</label>
                    <div class="searchable-select" id="editParentSelectContainer">
                        <input type="text" class="select-search" id="editParentSearch" placeholder="T√¨m ho·∫∑c ch·ªçn..." autocomplete="off">
                        <div class="select-options" id="editParentOptions"></div>
                    </div>
                    <input type="hidden" id="editParentId">
                </div>

                <div class="form-group" id="editChildOrderGroup" style="display: none;">
                    <label for="editChildOrder">L√† con th·ª©:</label>
                    <select id="editChildOrder">
                        <option value="">-- Ch·ªçn th·ª© t·ª± --</option>
                    </select>
                </div>

                <div class="form-group" id="editSpouseParentGroup" style="display: none;">
                    <label for="editSpouseParentId">L√† con c·ªßa (Cha/M·∫π):</label>
                    <div class="searchable-select" id="editSpouseParentSelectContainer">
                        <input type="text" class="select-search" id="editSpouseParentSearch" placeholder="Ch·ªçn v·ª£/ch·ªìng c·ªßa ng∆∞·ªùi ƒë√£ ch·ªçn ·ªü tr√™n..." autocomplete="off">
                        <div class="select-options" id="editSpouseParentOptions"></div>
                    </div>
                    <input type="hidden" id="editSpouseParentId">
                </div>

                <div class="form-group">
                    <label for="editNotes">Ghi ch√∫:</label>
                    <textarea id="editNotes" rows="3" placeholder="T·ªëi ƒëa 250 k√Ω t·ª±." maxlength="250" autocomplete="off"></textarea>
                </div>

                <button type="submit" class="btn-primary">C·∫≠p nh·∫≠t</button>
            </form>
        </div>
    </div>

    <!-- Edit Spouse Modal -->
    <div id="editSpouseModal" class="modal">
        <div class="modal-content">
            <span class="close-spouse-modal">&times;</span>
            <h2>S·ª≠a Th√¥ng Tin V·ª£/Ch·ªìng</h2>
            <form id="editSpouseForm">
                <input type="hidden" id="editSpouseMemberId">
                <input type="hidden" id="editSpouseIndex">
                
                <div class="form-group">
                    <label for="editSpouseNameInput">H·ªç v√† t√™n:</label>
                    <input type="text" id="editSpouseNameInput" required maxlength="30" autocomplete="off">
                </div>

                <div class="form-group">
                    <label for="editSpouseBirthYear">NƒÉm sinh:</label>
                    <input type="text" id="editSpouseBirthYear" maxlength="4" autocomplete="off">
                </div>

                <div class="form-group">
                    <label for="editSpouseDeathYear">NƒÉm m·∫•t:</label>
                    <div style="display: flex; align-items: center; gap: 10px; margin-bottom: 8px;">
                        <input type="checkbox" id="editSpouseIsDeceased" style="width: auto; margin: 0;">
                        <label for="editSpouseIsDeceased" style="margin: 0; cursor: pointer;">ƒê√£ m·∫•t</label>
                    </div>
                    <input type="text" id="editSpouseDeathYear" maxlength="4" placeholder="Nh·∫≠p nƒÉm m·∫•t..." autocomplete="off">
                </div>

                <div class="form-group">
                    <label for="editSpouseHometown">Qu√™ qu√°n:</label>
                    <input type="text" id="editSpouseHometown" placeholder="Nh·∫≠p qu√™ qu√°n..." autocomplete="off" maxlength="50">
                </div>

                <div class="form-group">
                    <label for="editSpouseOrder">L√† v·ª£/ch·ªìng th·ª©:</label>
                    <select id="editSpouseOrder">
                        <option value="">-- Ch·ªçn th·ª© t·ª± --</option>
                    </select>
                </div>

                <div class="form-group">
                    <label for="editSpouseNotes">Ghi ch√∫:</label>
                    <textarea id="editSpouseNotes" rows="3" placeholder="T·ªëi ƒëa 250 k√Ω t·ª±." maxlength="250" autocomplete="off"></textarea>
                </div>
                
                <button type="submit" class="btn-primary">C·∫≠p nh·∫≠t</button>
            </form>
        </div>
    </div>

    <!-- Detail Modal -->
    <div id="detailModal" class="modal">
        <div class="modal-content detail-modal-content">
            <span class="close-detail-modal">&times;</span>
            <h2>Th√¥ng Tin Chi Ti·∫øt</h2>
            <div id="detailContent"></div>
        </div>
    </div>

    <script src="firebase-config.js"></script>
    <script src="firebase-api.js"></script>
    <script src="script.js"></script>
    <script src="script-firebase.js"></script>
    <script>
        // H√†m hi·ªÉn th·ªã form ƒëƒÉng nh·∫≠p
        function showLoginForm() {
            document.getElementById('loginPrompt').style.display = 'none';
            document.getElementById('loginForm').style.display = 'block';
        }

        // H√†m h·ªßy ƒëƒÉng nh·∫≠p
        function cancelLogin() {
            document.getElementById('loginForm').style.display = 'none';
            document.getElementById('loginPrompt').style.display = 'block';
            document.getElementById('loginError').style.display = 'none';
        }

        // H√†m x·ª≠ l√Ω ƒëƒÉng nh·∫≠p v·ªõi Firebase Authentication
        async function handleFirebaseLogin(event) {
            event.preventDefault();
            
            const email = document.getElementById('loginEmail').value.trim();
            const password = document.getElementById('loginPassword').value;
            const errorDiv = document.getElementById('loginError');
            const successDiv = document.getElementById('loginSuccess');
            const loginBtn = document.getElementById('loginBtn');
            const loginBtnText = document.getElementById('loginBtnText');
            const loginBtnLoading = document.getElementById('loginBtnLoading');

            // ·∫®n th√¥ng b√°o c≈©
            errorDiv.style.display = 'none';
            successDiv.style.display = 'none';

            // Hi·ªÉn th·ªã loading
            loginBtnText.style.display = 'none';
            loginBtnLoading.style.display = 'inline';
            loginBtn.disabled = true;

            try {
                // ƒêƒÉng nh·∫≠p Firebase
                const userCredential = await firebase.auth().signInWithEmailAndPassword(email, password);
                const user = userCredential.user;
                
                console.log('‚úÖ ƒêƒÉng nh·∫≠p th√†nh c√¥ng:', user.email);

                // Hi·ªÉn th·ªã th√¥ng b√°o th√†nh c√¥ng
                successDiv.textContent = '‚úÖ ƒêƒÉng nh·∫≠p th√†nh c√¥ng! ƒêang t·∫£i...';
                successDiv.style.display = 'block';

                // L∆∞u tr·∫°ng th√°i ƒëƒÉng nh·∫≠p
                sessionStorage.setItem('isLoggedIn', 'true');
                sessionStorage.setItem('loginTime', new Date().getTime());
                sessionStorage.setItem('userEmail', user.email);
                
                // Delay ƒë·ªÉ hi·ªÉn th·ªã th√¥ng b√°o th√†nh c√¥ng
                setTimeout(() => {
                    // ·∫®n form ƒëƒÉng nh·∫≠p
                    document.getElementById('loginForm').style.display = 'none';
                    
                    // Hi·ªÉn th·ªã ph·∫ßn qu·∫£n tr·ªã
                    document.getElementById('adminControls').classList.add('show');
                    
                    // Hi·ªÉn th·ªã email ng∆∞·ªùi d√πng
                    const userEmailDiv = document.getElementById('userEmail');
                    if (userEmailDiv) {
                        userEmailDiv.textContent = `üë§ ƒêang ƒëƒÉng nh·∫≠p: ${user.email}`;
                    }
                    
                    // Hi·ªÉn th·ªã n√∫t undo/redo
                    const undoBtn = document.getElementById('undoBtn');
                    const redoBtn = document.getElementById('redoBtn');
                    if (undoBtn) undoBtn.style.display = 'inline-block';
                    if (redoBtn) redoBtn.style.display = 'inline-block';
                    
                    // Reset form
                    document.getElementById('loginEmail').value = '';
                    document.getElementById('loginPassword').value = '';
                    
                    // ‚úÖ Re-render tree ƒë·ªÉ hi·ªán n√∫t Edit/Delete
                    if (window.familyTree && typeof window.familyTree.renderTree === 'function') {
                        window.familyTree.renderTree();
                    }
                    
                    // Scroll xu·ªëng ph·∫ßn qu·∫£n tr·ªã
                    setTimeout(() => {
                        document.getElementById('adminControls').scrollIntoView({ 
                            behavior: 'smooth', 
                            block: 'start' 
                        });
                    }, 100);

                    // Reset button state
                    loginBtnText.style.display = 'inline';
                    loginBtnLoading.style.display = 'none';
                    loginBtn.disabled = false;
                }, 800);

            } catch (error) {
                console.error('‚ùå L·ªói ƒëƒÉng nh·∫≠p:', error);
                
                // Hi·ªÉn th·ªã th√¥ng b√°o l·ªói
                let errorMessage = '‚ùå ƒêƒÉng nh·∫≠p th·∫•t b·∫°i!';
                
                switch(error.code) {
                    case 'auth/invalid-email':
                        errorMessage = '‚ùå Email kh√¥ng h·ª£p l·ªá!';
                        break;
                    case 'auth/user-disabled':
                        errorMessage = '‚ùå T√†i kho·∫£n ƒë√£ b·ªã v√¥ hi·ªáu h√≥a!';
                        break;
                    case 'auth/user-not-found':
                        errorMessage = '‚ùå Kh√¥ng t√¨m th·∫•y t√†i kho·∫£n v·ªõi email n√†y!';
                        break;
                    case 'auth/wrong-password':
                        errorMessage = '‚ùå M·∫≠t kh·∫©u kh√¥ng ƒë√∫ng!';
                        break;
                    case 'auth/invalid-credential':
                        errorMessage = '‚ùå Email ho·∫∑c m·∫≠t kh·∫©u kh√¥ng ƒë√∫ng!';
                        break;
                    case 'auth/network-request-failed':
                        errorMessage = '‚ùå L·ªói k·∫øt n·ªëi m·∫°ng! Ki·ªÉm tra internet c·ªßa b·∫°n.';
                        break;
                    case 'auth/too-many-requests':
                        errorMessage = '‚ùå Qu√° nhi·ªÅu l·∫ßn ƒëƒÉng nh·∫≠p th·∫•t b·∫°i! Vui l√≤ng th·ª≠ l·∫°i sau.';
                        break;
                    default:
                        errorMessage = `‚ùå L·ªói: ${error.message}`;
                }
                
                errorDiv.textContent = errorMessage;
                errorDiv.style.display = 'block';
                
                // Reset button state
                loginBtnText.style.display = 'inline';
                loginBtnLoading.style.display = 'none';
                loginBtn.disabled = false;
                
                // Clear password
                document.getElementById('loginPassword').value = '';
            }
        }

        // H√†m ƒëƒÉng xu·∫•t v·ªõi Firebase
        async function handleLogout() {
            if (confirm('B·∫°n c√≥ ch·∫Øc mu·ªën ƒëƒÉng xu·∫•t?')) {
                try {
                    // ƒêƒÉng xu·∫•t Firebase
                    await firebase.auth().signOut();
                    console.log('‚úÖ ƒê√£ ƒëƒÉng xu·∫•t Firebase');
                    
                    // X√≥a session storage
                    sessionStorage.removeItem('isLoggedIn');
                    sessionStorage.removeItem('loginTime');
                    sessionStorage.removeItem('userEmail');
                    
                    // ·∫®n ph·∫ßn qu·∫£n tr·ªã
                    document.getElementById('adminControls').classList.remove('show');
                    document.getElementById('loginPrompt').style.display = 'block';
                    
                    // ·∫®n n√∫t undo/redo
                    const undoBtn = document.getElementById('undoBtn');
                    const redoBtn = document.getElementById('redoBtn');
                    if (undoBtn) undoBtn.style.display = 'none';
                    if (redoBtn) redoBtn.style.display = 'none';
                    
                    // ‚úÖ Re-render tree ƒë·ªÉ ·∫©n n√∫t Edit/Delete
                    if (window.familyTree && typeof window.familyTree.renderTree === 'function') {
                        window.familyTree.renderTree();
                    }
                    
                    // Scroll l√™n ph·∫ßn admin section
                    document.querySelector('.admin-section').scrollIntoView({ behavior: 'smooth' });
                    
                    alert('‚úÖ ƒê√£ ƒëƒÉng xu·∫•t th√†nh c√¥ng!');
                } catch (error) {
                    console.error('‚ùå L·ªói ƒëƒÉng xu·∫•t:', error);
                    alert('‚ùå L·ªói khi ƒëƒÉng xu·∫•t: ' + error.message);
                }
            }
        }

        // Ki·ªÉm tra tr·∫°ng th√°i ƒëƒÉng nh·∫≠p khi t·∫£i trang
        window.addEventListener('load', function() {
            // L·∫Øng nghe thay ƒë·ªïi tr·∫°ng th√°i ƒëƒÉng nh·∫≠p Firebase
            firebase.auth().onAuthStateChanged((user) => {
                if (user) {
                    // User ƒë√£ ƒëƒÉng nh·∫≠p
                    console.log('‚úÖ User ƒë√£ ƒëƒÉng nh·∫≠p:', user.email);
                    
                    // L∆∞u session
                    sessionStorage.setItem('isLoggedIn', 'true');
                    sessionStorage.setItem('loginTime', new Date().getTime());
                    sessionStorage.setItem('userEmail', user.email);
                    
                    // Hi·ªÉn th·ªã ph·∫ßn qu·∫£n tr·ªã
                    document.getElementById('loginPrompt').style.display = 'none';
                    document.getElementById('loginForm').style.display = 'none';
                    document.getElementById('adminControls').classList.add('show');
                    
                    // Hi·ªÉn th·ªã email
                    const userEmailDiv = document.getElementById('userEmail');
                    if (userEmailDiv) {
                        userEmailDiv.textContent = `üë§ ƒêang ƒëƒÉng nh·∫≠p: ${user.email}`;
                    }
                    
                    // Hi·ªÉn th·ªã n√∫t undo/redo
                    const undoBtn = document.getElementById('undoBtn');
                    const redoBtn = document.getElementById('redoBtn');
                    if (undoBtn) undoBtn.style.display = 'inline-block';
                    if (redoBtn) redoBtn.style.display = 'inline-block';
                } else {
                    // User ch∆∞a ƒëƒÉng nh·∫≠p
                    console.log('‚ÑπÔ∏è User ch∆∞a ƒëƒÉng nh·∫≠p');
                    
                    // X√≥a session
                    sessionStorage.removeItem('isLoggedIn');
                    sessionStorage.removeItem('loginTime');
                    sessionStorage.removeItem('userEmail');
                    
                    // Hi·ªÉn th·ªã n√∫t ƒëƒÉng nh·∫≠p
                    document.getElementById('loginPrompt').style.display = 'block';
                    document.getElementById('loginForm').style.display = 'none';
                    document.getElementById('adminControls').classList.remove('show');
                    
                    // ·∫®n n√∫t undo/redo
                    const undoBtn = document.getElementById('undoBtn');
                    const redoBtn = document.getElementById('redoBtn');
                    if (undoBtn) undoBtn.style.display = 'none';
                    if (redoBtn) redoBtn.style.display = 'none';
                }
            });
        });

        
        // Firebase connection checker (ch·ªâ log, kh√¥ng hi·ªÉn th·ªã UI)
        function checkFirebaseConnection() {
            const connectedRef = firebase.database().ref('.info/connected');
            connectedRef.on('value', (snapshot) => {
                if (snapshot.val() === true) {
                    console.log('‚úÖ Firebase connected');
                } else {
                    console.log('‚ö†Ô∏è Firebase disconnected');
                }
            });
        }
        
        // Show sync indicator
        function showSyncIndicator() {
            const indicator = document.getElementById('syncIndicator');
            if (indicator) {
                indicator.style.display = 'block';
                setTimeout(() => {
                    indicator.style.display = 'none';
                }, 2000);
            }
        }
        
        // Initialize on load
        window.addEventListener('load', () => {
            checkFirebaseConnection();
        });

    </script>
</body>
</html>